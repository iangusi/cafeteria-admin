{% extends 'base.html' %}
{% load static %}
{% block content %}
<h1>{% if creating %}Crear Venta{% else %}Editar Venta{% endif %}</h1>

<form method="post" id="venta-form">
  {% csrf_token %}
  <div class="mb-3">
    {{ form.titulo.label_tag }} {{ form.titulo }}
  </div>
  <div class="mb-3">
    {{ form.cliente.label_tag }} {{ form.cliente }}
    <button type="button" id="crear-cliente-btn" class="btn btn-sm btn-outline-secondary">Crear cliente</button>
  </div>

  <h3>Productos</h3>
  <table class="table table-sm" id="items-table">
    <thead>
      <tr>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Precio c/u</th>
        <th>Subtotal</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {{ formset.management_form }}
      {% for form_item in formset.forms %}
      <tr data-form-index="{{ forloop.counter0 }}">
        <td>
          {{ form_item.producto }}
        </td>
        <td>
          {{ form_item.cantidad }}
        </td>
        <td class="precio-cell">
          {% comment %} mostramos precio actual del producto (si está cargado en el item) {% endcomment %}
          {% with item=form_item.instance %}
            ${{ item.precio|default:"0.00" }}
          {% endwith %}
        </td>
        <td class="subtotal-cell">
          {% with item=form_item.instance %}
            ${{ item.precio|default:"0.00"|floatformat:2|add:"0" }}{% comment %} se actualizará por JS {% endcomment %}
          {% endwith %}
        </td>
        <td>
          <button type="button" class="btn btn-sm btn-outline-secondary personalizar-btn">Personalizar</button>
          {{ form_item.DELETE }}
          <button type="button" class="btn btn-sm btn-danger remove-row-btn">Eliminar</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="mt-3">
    <button type="submit" class="btn btn-primary">Guardar venta</button>
    <a href="{% url 'ventas_list' %}" class="btn btn-secondary">Volver</a>
  </div>
</form>

<!-- Modal para personalizar: abre un formulario pre-llenado (se crea producto via AJAX) -->
<div class="modal fade" id="personalizarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Personalizar producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <!-- Aquí se inyectará el formulario duplicado del producto (o una versión embebida) -->
        <form id="personalizar-form">
          <div id="personalizar-form-fields">
            <!-- campos precargados via JS -->
          </div>
          <div class="mt-2">
            <button type="button" id="personalizar-crear-btn" class="btn btn-primary">Crear producto personalizado</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'js/jquery.min.js' %}"></script>
<script>
$(function(){
  // Actualiza subtotal cuando cambian cantidad o producto
  $('#items-table').on('change', 'select, input', function(){
    updateRowSubtotal($(this).closest('tr'));
  });

  function updateRowSubtotal($tr){
    // intenta leer precio desde el select (opción seleccionada) o desde instancia (si está)
    var precio = 0;
    var sel = $tr.find('select');
    if(sel.length){
      var opt = sel.find('option:selected');
      // asumo que cada option tiene data-precio con precio del producto
      precio = parseFloat(opt.data('precio') || opt.attr('data-precio') || 0);
    }
    var cantidad = parseInt($tr.find('input[type="number"]').val() || 0);
    var subtotal = (precio * cantidad) || 0;
    $tr.find('.precio-cell').text('$' + precio.toFixed(2));
    $tr.find('.subtotal-cell').text('$' + subtotal.toFixed(2));
  }

  // Eliminar fila (marcar DELETE en management form)
  $('#items-table').on('click', '.remove-row-btn', function(){
    var $tr = $(this).closest('tr');
    // si el formset tiene checkbox DELETE, marcarlo; si no, remover el tr y ajustar management form
    var $deleteInput = $tr.find('input[type="checkbox"][name$="-DELETE"]');
    if($deleteInput.length){
      $deleteInput.prop('checked', true);
      $tr.hide();
    } else {
      $tr.remove();
      // TODO: si tienes un botón "agregar fila" deberías incrementar TOTAL_FORMS etc.
    }
  });

  // Personalizar: abrir modal y prellenar con producto actual (usando data del select)
  var currentRowIndex = null;
  $('#items-table').on('click', '.personalizar-btn', function(){
    var $tr = $(this).closest('tr');
    currentRowIndex = $tr.data('form-index');
    var $sel = $tr.find('select');
    var productoId = $sel.val();
    var productoNombre = $sel.find('option:selected').text();
    var productoPrecio = $sel.find('option:selected').data('precio') || 0;

    // Prellenamos el modal con campos mínimos para duplicar producto
    $('#personalizar-form-fields').html(`
      <div class="mb-2">
        <label>Nombre</label>
        <input type="text" id="p_nombre" class="form-control" value="${productoNombre}">
      </div>
      <div class="mb-2">
        <label>Precio</label>
        <input type="number" id="p_precio" class="form-control" value="${productoPrecio}" step="0.01">
      </div>
      <input type="hidden" id="p_producto_id" value="${productoId}">
    `);
    var modal = new bootstrap.Modal(document.getElementById('personalizarModal'));
    modal.show();
  });

  // Al crear producto personalizado: POST a endpoint que duplica producto (venta_personalize_create)
  $('#personalizar-crear-btn').on('click', function(){
    var producto_id = $('#p_producto_id').val();
    var nombre_nuevo = $('#p_nombre').val();
    var precio_nuevo = $('#p_precio').val();

    $.post("{% url 'venta_personalize_create' %}", {
      producto_id: producto_id,
      csrfmiddlewaretoken: '{{ csrf_token }}'
    }).done(function(resp){
      if(resp.ok){
        // resp.nuevo_producto_id / nuevo_producto_nombre
        // Actualizar el select del row actual para seleccionar el nuevo producto.
        var $tr = $('#items-table').find('tr[data-form-index="'+currentRowIndex+'"]');
        var $select = $tr.find('select');
        // Si la opción no existe, la añadimos y la seleccionamos.
        if($select.find('option[value="'+resp.nuevo_producto_id+'"]').length == 0){
          $select.append($('<option>').val(resp.nuevo_producto_id).text(resp.nuevo_producto_nombre).attr('data-precio', precio_nuevo));
        }
        $select.val(resp.nuevo_producto_id).trigger('change');
        // cerrar modal
        var modalEl = document.getElementById('personalizarModal');
        var modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
      } else {
        alert('No se pudo personalizar el producto: ' + (resp.error || 'error'));
      }
    }).fail(function(xhr){
      alert('Error al contactar al servidor: ' + xhr.responseText);
    });

  });

  // Inicial update rows
  $('#items-table tbody tr').each(function(){
    updateRowSubtotal($(this));
  });
});
</script>
{% endblock %}